#!/bin/bash

# Penetration Testing Script for Security Analytics Dashboard
# Run: bash pentest.sh [baseURL] [delay]
# Example: bash pentest.sh http://localhost:3000 1000

BASE_URL="${1:-http://localhost:3000}"
DELAY="${2:-1000}"

# Colors
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

echo -e "${CYAN}======================================${NC}"
echo -e "${CYAN}Portfolio Penetration Testing Suite${NC}"
echo -e "${CYAN}======================================${NC}"
echo ""
echo -e "${YELLOW}Target: $BASE_URL${NC}"
echo -e "${YELLOW}Auto-refresh delay: ${DELAY}ms${NC}"
echo ""
echo -e "${GREEN}INSTRUCTIONS:${NC}"
echo -e "${GREEN}1. Open security analytics page in browser: $BASE_URL/security-analytics${NC}"
echo -e "${GREEN}2. Watch the dashboard as attacks are simulated below${NC}"
echo ""
echo -e "${YELLOW}Starting penetration tests in 3 seconds...${NC}"
echo ""

sleep 3

# Test 1: SQL Injection
echo -e "${MAGENTA}[1/5] SQL Injection Test (SQLMap)${NC}"
sql_payloads=(
    "?id=1' OR '1'='1"
    "?user=admin' --"
    "?search='; DROP TABLE users; --"
)

for payload in "${sql_payloads[@]}"; do
    url="$BASE_URL/api/security$payload"
    curl -s -H "User-Agent: sqlmap/1.8.3" "$url" > /dev/null 2>&1
    echo -e "${RED}  ✓ SQL Injection payload sent: $payload${NC}"
    sleep $(( DELAY / 1000 ))
done
echo ""

# Test 2: Brute Force
echo -e "${MAGENTA}[2/5] Brute Force Login Test (Hydra)${NC}"
users=("admin" "administrator" "user" "test")

for user in "${users[@]}"; do
    url="$BASE_URL/sign-in?attempt=$user"
    curl -s -H "User-Agent: hydra/9.3 (HTTPS form-post-get)" "$url" > /dev/null 2>&1
    echo -e "${RED}  ✓ Brute force attempt: User=$user${NC}"
    sleep $(( DELAY / 1000 ))
done
echo ""

# Test 3: XSS
echo -e "${MAGENTA}[3/5] Cross-Site Scripting Test (XSSer)${NC}"
xss_payloads=(
    "<script>alert('xss')</script>"
    "<img src=x onerror=alert('xss')>"
)

for payload in "${xss_payloads[@]}"; do
    encoded=$(echo -n "$payload" | jq -sRr @uri)
    url="$BASE_URL/api/security?payload=$encoded"
    curl -s -H "User-Agent: xsser/1.8" "$url" > /dev/null 2>&1
    echo -e "${RED}  ✓ XSS payload sent: $payload${NC}"
    sleep $(( DELAY / 1000 ))
done
echo ""

# Test 4: Rate Limiting
echo -e "${MAGENTA}[4/5] Rate Limiting Test (ApacheBench)${NC}"
for i in {1..5}; do
    curl -s -H "User-Agent: ApacheBench/2.3" "$BASE_URL/" > /dev/null 2>&1
    echo -e "${YELLOW}  ✓ Rate limit test request $i/5${NC}"
    sleep $(( DELAY / 1000 ))
done
echo ""

# Test 5: Bot Detection
echo -e "${MAGENTA}[5/5] Bot Detection Test (Python Requests)${NC}"
bot_paths=("/api/security" "/" "/security")

for path in "${bot_paths[@]}"; do
    url="$BASE_URL$path"
    curl -s -H "User-Agent: python-requests/2.31.0" "$url" > /dev/null 2>&1
    echo -e "${CYAN}  ✓ Bot detection test: $path${NC}"
    sleep $(( DELAY / 1000 ))
done
echo ""

# Test 6: Direct API Event Logging
echo -e "${MAGENTA}[BONUS] Direct API Event Logging${NC}"

# SQL Injection event
curl -s -X POST "$BASE_URL/api/security" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "SQL_INJECTION",
    "severity": "CRITICAL",
    "ip": "192.168.1.100",
    "path": "/security",
    "reason": "sqlmap detected multiple injection payloads",
    "method": "GET"
  }' > /dev/null 2>&1
echo -e "${CYAN}  ✓ Logged event: SQL_INJECTION${NC}"
sleep $(( DELAY / 1000 ))

# Brute Force event
curl -s -X POST "$BASE_URL/api/security" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "BRUTE_FORCE",
    "severity": "HIGH",
    "ip": "192.168.1.100",
    "path": "/security",
    "reason": "hydra: 4 failed login attempts in 10 seconds",
    "method": "GET"
  }' > /dev/null 2>&1
echo -e "${CYAN}  ✓ Logged event: BRUTE_FORCE${NC}"
sleep $(( DELAY / 1000 ))

# XSS event
curl -s -X POST "$BASE_URL/api/security" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "XSS_ATTEMPT",
    "severity": "MEDIUM",
    "ip": "192.168.1.100",
    "path": "/security",
    "reason": "xsser: script injection detected in query params",
    "method": "GET"
  }' > /dev/null 2>&1
echo -e "${CYAN}  ✓ Logged event: XSS_ATTEMPT${NC}"
echo ""

echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}Penetration Tests Complete!${NC}"
echo -e "${GREEN}======================================${NC}"
echo ""
echo -e "${YELLOW}View Results:${NC}"
echo -e "${CYAN}  Dashboard: $BASE_URL/security-analytics${NC}"
echo -e "${CYAN}  Full Logs:  $BASE_URL/security${NC}"
echo ""
echo -e "${YELLOW}To clear events and run again:${NC}"
echo -e "${CYAN}  curl -X POST $BASE_URL/api/security -H 'Content-Type: application/json' -d '{\"clear\":true}'${NC}"
echo ""
