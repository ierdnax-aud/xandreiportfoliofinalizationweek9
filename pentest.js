#!/usr/bin/env node

/**
 * Penetration Testing Script for Security Analytics Dashboard
 * 
 * Usage: node pentest.js [baseURL] [delay]
 * Example: node pentest.js http://localhost:3000 1000
 */

const http = require('http');
const https = require('https');
const url = require('url');

const baseURL = process.argv[2] || 'http://localhost:3000';
const delay = parseInt(process.argv[3]) || 1000;

console.log('\x1b[36m%s\x1b[0m', '======================================');
console.log('\x1b[36m%s\x1b[0m', 'Portfolio Penetration Testing Suite');
console.log('\x1b[36m%s\x1b[0m', '======================================');
console.log('');
console.log('\x1b[33m%s\x1b[0m', `Target: ${baseURL}`);
console.log('\x1b[33m%s\x1b[0m', `Auto-refresh delay: ${delay}ms`);
console.log('');
console.log('\x1b[32m%s\x1b[0m', 'INSTRUCTIONS:');
console.log('\x1b[32m%s\x1b[0m', `1. Open security analytics page in browser: ${baseURL}/security-analytics`);
console.log('\x1b[32m%s\x1b[0m', '2. Watch the dashboard as attacks are simulated below');
console.log('');
console.log('\x1b[33m%s\x1b[0m', 'Starting penetration tests in 3 seconds...');
console.log('');

// Helper function to make HTTP requests
function makeRequest(targetUrl, userAgent, method = 'GET', body = null) {
  return new Promise((resolve, reject) => {
    const parsedUrl = new url.URL(targetUrl);
    const isHttps = parsedUrl.protocol === 'https:';
    const client = isHttps ? https : http;

    const options = {
      hostname: parsedUrl.hostname,
      port: parsedUrl.port,
      path: parsedUrl.pathname + parsedUrl.search,
      method: method,
      headers: {
        'User-Agent': userAgent,
        'Content-Type': 'application/json',
      },
    };

    if (body) {
      const bodyStr = JSON.stringify(body);
      options.headers['Content-Length'] = Buffer.byteLength(bodyStr);
    }

    const req = client.request(options, (res) => {
      let data = '';
      res.on('data', (chunk) => {
        data += chunk;
      });
      res.on('end', () => {
        resolve({ status: res.statusCode, data });
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    if (body) {
      req.write(JSON.stringify(body));
    }

    req.end();
  });
}

async function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

async function runTests() {
  try {
    // Test 1: SQL Injection
    console.log('\x1b[35m%s\x1b[0m', '[1/5] SQL Injection Test (SQLMap)');
    const sqlPayloads = [
      "?id=1' OR '1'='1",
      "?user=admin' --",
      "?search='; DROP TABLE users; --",
    ];

    for (const payload of sqlPayloads) {
      try {
        const targetUrl = `${baseURL}/api/security${payload}`;
        await makeRequest(targetUrl, 'sqlmap/1.8.3');
        console.log('\x1b[31m%s\x1b[0m', `  ✓ SQL Injection payload sent: ${payload}`);
      } catch (e) {
        console.log('\x1b[31m%s\x1b[0m', `  ✓ SQL Injection payload sent: ${payload} (may be blocked)`);
      }
      await sleep(delay);
    }
    console.log('');

    // Test 2: Brute Force
    console.log('\x1b[35m%s\x1b[0m', '[2/5] Brute Force Login Test (Hydra)');
    const loginAttempts = ['admin', 'administrator', 'user', 'test'];

    for (const user of loginAttempts) {
      try {
        const targetUrl = `${baseURL}/sign-in?attempt=${user}`;
        await makeRequest(targetUrl, 'hydra/9.3 (HTTPS form-post-get)');
        console.log('\x1b[31m%s\x1b[0m', `  ✓ Brute force attempt: User=${user}`);
      } catch (e) {
        console.log('\x1b[31m%s\x1b[0m', `  ✓ Brute force attempt: User=${user} (may be blocked)`);
      }
      await sleep(delay);
    }
    console.log('');

    // Test 3: XSS
    console.log('\x1b[35m%s\x1b[0m', '[3/5] Cross-Site Scripting Test (XSSer)');
    const xssPayloads = [
      "<script>alert('xss')</script>",
      "<img src=x onerror=alert('xss')>",
    ];

    for (const payload of xssPayloads) {
      try {
        const encoded = encodeURIComponent(payload);
        const targetUrl = `${baseURL}/api/security?payload=${encoded}`;
        await makeRequest(targetUrl, 'xsser/1.8');
        console.log('\x1b[31m%s\x1b[0m', `  ✓ XSS payload sent: ${payload}`);
      } catch (e) {
        console.log('\x1b[31m%s\x1b[0m', `  ✓ XSS payload sent: ${payload} (may be blocked)`);
      }
      await sleep(delay);
    }
    console.log('');

    // Test 4: Rate Limiting
    console.log('\x1b[35m%s\x1b[0m', '[4/6] Rate Limiting Test (ApacheBench)');
    console.log('\x1b[33m%s\x1b[0m', '  Testing rapid sequential requests to trigger rate limits...');
    
    // Rapid requests to different endpoints
    const rateLimitEndpoints = [
      '/api/security',
      '/',
      '/security',
      '/security-analytics',
      '/about',
    ];
    
    for (let i = 0; i < 10; i++) {
      const endpoint = rateLimitEndpoints[i % rateLimitEndpoints.length];
      try {
        await makeRequest(`${baseURL}${endpoint}`, 'ApacheBench/2.3');
        console.log('\x1b[33m%s\x1b[0m', `  ✓ Rate limit test request ${i + 1}/10 to ${endpoint}`);
      } catch (e) {
        console.log('\x1b[33m%s\x1b[0m', `  ✓ Rate limit test request ${i + 1}/10 to ${endpoint} (may be blocked)`);
      }
      // Reduce delay for rate limiting to actually trigger
      await sleep(Math.max(100, delay / 5));
    }
    console.log('');

    // Test 5: Bot Detection  
    console.log('\x1b[35m%s\x1b[0m', '[5/6] Bot Detection Test (Multiple Bot User-Agents)');
    console.log('\x1b[36m%s\x1b[0m', '  Testing detection of automated crawlers and bots...');
    
    const botAgents = [
      'python-requests/2.31.0',
      'curl/7.68.0',
      'wget/1.20.3',
      'Go-http-client/1.1',
      'Scrapy/2.11.0',
      'Mozilla/5.0 (compatible; Googlebot/2.0)',
      'Mozilla/5.0 (compatible; bingbot/2.0)',
      'Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0',
    ];
    
    for (const agent of botAgents) {
      try {
        const target = `${baseURL}/api/security`;
        await makeRequest(target, agent);
        const agentName = agent.split('/')[0];
        console.log('\x1b[36m%s\x1b[0m', `  ✓ Bot detection test: ${agentName}`);
      } catch (e) {
        const agentName = agent.split('/')[0];
        console.log('\x1b[36m%s\x1b[0m', `  ✓ Bot detection test: ${agentName} (may be blocked)`);
      }
      await sleep(delay / 2);
    }
    console.log('');

    // Test 6: Direct API Event Logging
    console.log('\x1b[35m%s\x1b[0m', '[BONUS] Direct API Event Logging');
    const apiEvents = [
      {
        type: 'SQL_INJECTION',
        severity: 'CRITICAL',
        reason: 'sqlmap detected multiple injection payloads',
      },
      {
        type: 'BRUTE_FORCE',
        severity: 'HIGH',
        reason: 'hydra: 4 failed login attempts in 10 seconds',
      },
      {
        type: 'XSS_ATTEMPT',
        severity: 'MEDIUM',
        reason: 'xsser: script injection detected in query params',
      },
      {
        type: 'RATE_LIMIT',
        severity: 'HIGH',
        reason: 'apachebench: 10 requests from same IP in 5 seconds',
      },
      {
        type: 'BOT_DETECTED',
        severity: 'MEDIUM',
        reason: 'automated bot detected: python-requests, curl, wget, scrapy',
      },
    ];

    for (const event of apiEvents) {
      try {
        const eventPayload = {
          type: event.type,
          severity: event.severity,
          ip: '192.168.1.100',
          path: '/security',
          reason: event.reason,
          method: 'GET',
        };
        await makeRequest(`${baseURL}/api/security`, 'node-pentest/1.0', 'POST', eventPayload);
        console.log('\x1b[36m%s\x1b[0m', `  ✓ Logged event: ${event.type}`);
      } catch (e) {
        console.log('\x1b[36m%s\x1b[0m', `  ✓ Logged event: ${event.type} (may have failed)`);
      }
      await sleep(delay);
    }
    console.log('');

    console.log('\x1b[32m%s\x1b[0m', '======================================');
    console.log('\x1b[32m%s\x1b[0m', 'Penetration Tests Complete!');
    console.log('\x1b[32m%s\x1b[0m', '======================================');
    console.log('');
    console.log('\x1b[33m%s\x1b[0m', 'View Results:');
    console.log('\x1b[36m%s\x1b[0m', `  Dashboard: ${baseURL}/security-analytics`);
    console.log('\x1b[36m%s\x1b[0m', `  Full Logs:  ${baseURL}/security`);
    console.log('');
    console.log('\x1b[33m%s\x1b[0m', 'To clear events and run again:');
    console.log(
      '\x1b[36m%s\x1b[0m',
      `  curl -X POST ${baseURL}/api/security -H "Content-Type: application/json" -d '{"clear":true}'`
    );
    console.log('');
  } catch (error) {
    console.error('Error during penetration tests:', error);
    process.exit(1);
  }
}

// Start tests after 3 seconds
setTimeout(runTests, 3000);
