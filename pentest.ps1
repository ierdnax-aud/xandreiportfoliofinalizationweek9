# Penetration Testing Script for Security Analytics Dashboard
# Run this to test the security dashboard and see attacks logged in real-time

param(
    [string]$BaseURL = "http://localhost:3000",
    [int]$Delay = 1000
)

Write-Host "======================================" -ForegroundColor Cyan
Write-Host "Portfolio Penetration Testing Suite" -ForegroundColor Cyan
Write-Host "======================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Target: $BaseURL" -ForegroundColor Yellow
Write-Host "Auto-refresh delay: ${Delay}ms" -ForegroundColor Yellow
Write-Host ""
Write-Host "INSTRUCTIONS:" -ForegroundColor Green
Write-Host "1. Open security analytics page in browser: $BaseURL/security-analytics" -ForegroundColor Green
Write-Host "2. Watch the dashboard as attacks are simulated below" -ForegroundColor Green
Write-Host ""
Write-Host "Starting penetration tests in 3 seconds..." -ForegroundColor Yellow
Write-Host ""
Start-Sleep -Seconds 3

# Test 1: SQLMap Detection
Write-Host "[1/5] SQL Injection Test (SQLMap)" -ForegroundColor Magenta
$sqlPayloads = @(
    "?id=1' OR '1'='1",
    "?user=admin' --",
    "?search='; DROP TABLE users; --"
)

foreach ($payload in $sqlPayloads) {
    $url = "$BaseURL/api/security$payload"
    Invoke-WebRequest -Uri $url -UserAgent "sqlmap/1.8.3" -Method GET -ErrorAction SilentlyContinue | Out-Null
    Write-Host "  ✓ SQL Injection payload sent: $payload" -ForegroundColor Red
    Start-Sleep -Milliseconds $Delay
}
Write-Host ""

# Test 2: Brute Force Detection
Write-Host "[2/5] Brute Force Login Test (Hydra)" -ForegroundColor Magenta
$loginAttempts = @("admin", "administrator", "user", "test")

foreach ($user in $loginAttempts) {
    $url = "$BaseURL/sign-in?attempt=$user"
    Invoke-WebRequest -Uri $url -UserAgent "hydra/9.3 (HTTPS form-post-get)" -Method GET -ErrorAction SilentlyContinue | Out-Null
    Write-Host "  ✓ Brute force attempt: User=$user" -ForegroundColor Red
    Start-Sleep -Milliseconds $Delay
}
Write-Host ""

# Test 3: XSS Detection
Write-Host "[3/5] Cross-Site Scripting Test (XSSer)" -ForegroundColor Magenta
$xssPayloads = @(
    "<script>alert('xss')</script>",
    "<img src=x onerror=alert('xss')>"
)

foreach ($payload in $xssPayloads) {
    $encodedPayload = [System.Web.HttpUtility]::UrlEncode($payload)
    $url = "$BaseURL/api/security?payload=$encodedPayload"
    Invoke-WebRequest -Uri $url -UserAgent "xsser/1.8" -Method GET -ErrorAction SilentlyContinue | Out-Null
    Write-Host "  ✓ XSS payload sent: $payload" -ForegroundColor Red
    Start-Sleep -Milliseconds $Delay
}
Write-Host ""

# Test 4: Rate Limiting Detection
Write-Host "[4/5] Rate Limiting Test (ApacheBench)" -ForegroundColor Magenta
for ($i = 1; $i -le 5; $i++) {
    $url = "$BaseURL/"
    Invoke-WebRequest -Uri $url -UserAgent "ApacheBench/2.3" -Method GET -ErrorAction SilentlyContinue | Out-Null
    Write-Host "  ✓ Rate limit test request $i/5" -ForegroundColor Yellow
    Start-Sleep -Milliseconds $Delay
}
Write-Host ""

# Test 5: Bot Detection
Write-Host "[5/5] Bot Detection Test (Python Requests)" -ForegroundColor Magenta
$botPaths = @("/api/security", "/", "/security")

foreach ($path in $botPaths) {
    $url = "$BaseURL$path"
    Invoke-WebRequest -Uri $url -UserAgent "python-requests/2.31.0" -Method GET -ErrorAction SilentlyContinue | Out-Null
    Write-Host "  ✓ Bot detection test: $path" -ForegroundColor Cyan
    Start-Sleep -Milliseconds $Delay
}
Write-Host ""

# Direct API Event Logging
Write-Host "[BONUS] Direct API Event Logging" -ForegroundColor Magenta
$apiEvents = @(
    @{ type = "SQL_INJECTION"; severity = "CRITICAL"; reason = "sqlmap detected multiple injection payloads" },
    @{ type = "BRUTE_FORCE"; severity = "HIGH"; reason = "hydra: 4 failed login attempts in 10 seconds" },
    @{ type = "XSS_ATTEMPT"; severity = "MEDIUM"; reason = "xsser: script injection detected in query params" }
)

foreach ($event in $apiEvents) {
    $body = @{
        type = $event.type
        severity = $event.severity
        ip = "192.168.1.100"
        path = "/security"
        reason = $event.reason
        method = "GET"
    } | ConvertTo-Json
    
    Invoke-WebRequest -Uri "$BaseURL/api/security" -Method POST -Headers @{"Content-Type" = "application/json"} -Body $body -ErrorAction SilentlyContinue | Out-Null
    Write-Host "  ✓ Logged event: $($event.type)" -ForegroundColor Cyan
    Start-Sleep -Milliseconds $Delay
}
Write-Host ""

Write-Host "======================================" -ForegroundColor Green
Write-Host "Penetration Tests Complete!" -ForegroundColor Green
Write-Host "======================================" -ForegroundColor Green
Write-Host ""
Write-Host "View Results:" -ForegroundColor Yellow
Write-Host "  Dashboard: $BaseURL/security-analytics" -ForegroundColor Cyan
Write-Host "  Full Logs:  $BaseURL/security" -ForegroundColor Cyan
Write-Host ""
Write-Host "To clear events and run again:" -ForegroundColor Yellow
Write-Host '  Invoke-WebRequest -Uri "$BaseURL/api/security" -Method POST -Headers @{"Content-Type" = "application/json"} -Body ''{"clear":true}''' -ForegroundColor Cyan
